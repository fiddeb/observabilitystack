# Mimir configuration - Monolithic mode
# Based on NGDATA fork: https://github.com/NGDATA/mimir/blob/main/operations/helm/charts/mimir-distributed/monolithic.yaml

mimir:
  # Monolithic deployment mode (single binary running all components)
  deploymentMode: monolithic

  fullnameOverride: mimir

  # Don't use template-based config generation
  useExternalConfig: false

  # Override config template completely to avoid MinIO references
  mimir:
    config: |
      usage_stats:
        installation_mode: helm

      activity_tracker:
        filepath: /active-query-tracker/activity.log

      alertmanager:
        data_dir: /data/alertmanager
        enable_api: true
        external_url: /alertmanager

      blocks_storage:
        backend: filesystem
        filesystem:
          dir: /data/mimir/blocks
        bucket_store:
          sync_dir: /data/tsdb-sync
        tsdb:
          dir: /data/tsdb
          head_compaction_interval: 15m
          wal_replay_concurrency: 3

      compactor:
        compaction_interval: 30m
        deletion_delay: 2h
        data_dir: /data/compactor
        sharding_ring:
          wait_stability_min_duration: 1m

      distributor:
        ring:
          heartbeat_period: 1m
          heartbeat_timeout: 4m

      frontend:
        parallelize_shardable_queries: true

      frontend_worker:
        grpc_client_config:
          max_send_msg_size: 419430400

      ingester:
        ring:
          final_sleep: 0s
          num_tokens: 512
          unregister_on_shutdown: false
          heartbeat_period: 2m
          heartbeat_timeout: 10m
          zone_awareness_enabled: false

      ingester_client:
        grpc_client_config:
          max_recv_msg_size: 104857600
          max_send_msg_size: 104857600

      limits:
        max_total_query_length: 12000h
        max_query_parallelism: 240
        max_cache_freshness: 10m
        compactor_blocks_retention_period: 30d

      memberlist:
        abort_if_cluster_join_fails: false
        compression_enabled: false
        join_members:
          - dns+mimir-gossip-ring.observability-lab.svc.cluster.local.:7946

      querier:
        max_concurrent: 16

      query_scheduler:
        max_outstanding_requests_per_tenant: 800

      ruler:
        alertmanager_url: dnssrvnoa+http://_http-metrics._tcp.mimir-monolithic-headless.observability-lab.svc.cluster.local./alertmanager
        enable_api: true
        rule_path: /data/ruler

      runtime_config:
        file: /var/mimir/runtime.yaml

      store_gateway:
        sharding_ring:
          heartbeat_period: 1m
          heartbeat_timeout: 10m
          wait_stability_min_duration: 1m
          tokens_file_path: /data/tokens
          unregister_on_shutdown: false
          zone_awareness_enabled: false

  # Monolithic pod configuration
  monolithic:
    replicas: 1  # Single instance for local dev
    
    # Disable zone-aware replication (NGDATA fork has enabled: true by default)
    zoneAwareReplication:
      enabled: false
    
    persistentVolume:
      enabled: true
      size: "10Gi"
      # storageClass: "" # Use default storageClass

    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "1Gi"
        cpu: "500m"
    
    readinessProbe:
      httpGet:
        path: /ready
        port: http-metrics
      initialDelaySeconds: 45
      timeoutSeconds: 5
      periodSeconds: 10
      successThreshold: 1
      failureThreshold: 3
    
    livenessProbe:
      httpGet:
        path: /ready
        port: http-metrics
      initialDelaySeconds: 60
      timeoutSeconds: 5
      periodSeconds: 30
      successThreshold: 1
      failureThreshold: 10

  # Gateway configuration (use nginx or disable completely)
  gateway:
    replicas: 1
    ingress:
      enabled: true
      ingressClassName: traefik
      hosts:
        - host: mimir.k8s.test
          paths:
            - path: /
              pathType: Prefix
      tls: []

  # Nginx disabled (using gateway instead)
  nginx:
    enabled: false

  # Disable MinIO (using filesystem)
  minio:
    enabled: false

  # Disable Kafka (not needed for filesystem storage)
  kafka:
    enabled: false

  # Alertmanager disabled for initial setup
  alertmanager:
    enabled: false

  # Disable all caches for simplicity
  chunks-cache:
    enabled: false
  index-cache:
    enabled: false
  metadata-cache:
    enabled: false
  results-cache:
    enabled: false

  # Explicitly disable microservices components (we're in monolithic mode)
  distributor:
    replicas: 0
  ingester:
    replicas: 0
    zoneAwareReplication:
      enabled: false
  querier:
    replicas: 0
  query_frontend:
    replicas: 0
  compactor:
    replicas: 0
  store_gateway:
    replicas: 0
    zoneAwareReplication:
      enabled: false
  ruler:
    replicas: 0
  overrides_exporter:
    replicas: 0
