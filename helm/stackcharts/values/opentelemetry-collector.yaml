# OpenTelemetry Collector configuration
# Central telemetry ingestion and routing

opentelemetry-collector:
  fullnameOverride: "otel-collector"
  
  mode: "deployment"
  
  image:
    repository: "otel/opentelemetry-collector-contrib"
    tag: "latest"
    pullPolicy: "IfNotPresent"
  
  command:
    name: "otelcol-contrib"
  
  config:
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
      
      loki:
        protocols:
          http:
            endpoint: 0.0.0.0:3101
        use_incoming_timestamp: true
    
    processors:
      memory_limiter:
        check_interval: 2s
        limit_percentage: 75
        spike_limit_percentage: 25
      
      batch:
        send_batch_size: 4096
        send_batch_max_size: 8192
        timeout: 50ms

    connectors:
      routing:
        default_pipelines: [logs/default]
        table:
          - context: log
            statement: |
              route() where
                attributes["dev.audit.category"] != nil or
                attributes["dev.audit.severity"] != nil
            pipelines: [logs/audit]

    exporters:
      debug/default:
        verbosity: basic
      
      debug/audit: 
        verbosity: detailed
     # Traces to Tempo
      otlp/tempo:
       endpoint: http://tempo.observability-lab.svc.cluster.local:4317
       tls:
          insecure: true
      
      # Logs to Loki
      otlphttp/default:
        logs_endpoint: http://loki-gateway.observability-lab.svc.cluster.local/otlp/v1/logs
        headers:
          "X-Scope-OrgID": foo
        sending_queue:
          enabled: true
          num_consumers: 40
          queue_size: 5000
        retry_on_failure:
          enabled: true
          initial_interval: 500ms
          max_interval: 10s
      # Logs to Loki
      otlphttp/bazz:
        logs_endpoint: http://loki-gateway.observability-lab.svc.cluster.local/otlp/v1/logs
        headers:
          "X-Scope-OrgID": bazz
        sending_queue:
          enabled: true
          num_consumers: 40
          queue_size: 5000
        retry_on_failure:
          enabled: true
          initial_interval: 500ms
          max_interval: 10s
      # Metrics to Prometheus via OTLP (native)
      otlphttp/prometheus:
        endpoint: http://prometheus.observability-lab.svc.cluster.local:80/api/v1/otlp/
        tls:
          insecure: true
        sending_queue:
          enabled: true
          num_consumers: 10
          queue_size: 1000
        retry_on_failure:
          enabled: true
          initial_interval: 500ms
          max_interval: 10s
      otlphttp/mimir:
        endpoint: http://mimir-monolithic.observability-lab.svc.cluster.local:80/api/v1/otlp/
        tls:
          insecure: true
        sending_queue:
          enabled: true
          num_consumers: 10
          queue_size: 1000
        retry_on_failure:
          enabled: true
          initial_interval: 500ms
          max_interval: 10s
    
    service:
      pipelines:
        traces:
         receivers: [otlp]
         processors: [memory_limiter, batch]
         exporters: [otlp/tempo]
        
        logs:
          receivers: [otlp, loki]
          processors: [memory_limiter, batch]
          exporters: [routing]
        
        metrics:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [otlphttp/prometheus]
        logs/default:
          receivers: [routing]
          exporters: [otlphttp/default]
        logs/audit:
          receivers: [routing]
          processors: [memory_limiter, batch]
          exporters: [otlphttp/bazz, debug/audit]

  resources:
    requests:
      cpu: "500m"
      memory: "512Mi"
    limits:
      cpu: "2000m"
      memory: "4096Mi"

  ports:
    loki:
      enabled: true
      containerPort: 3101
      servicePort: 3101
      protocol: TCP

  ingress:
    enabled: true
    ingressClassName: "traefik"
    annotations:
      traefik.ingress.kubernetes.io/router.middlewares: observability-lab-strip-loki-prefix@kubernetescrd
    hosts:
      - host: otel-collector.k8s.test
        paths:
          - path: /
            pathType: Prefix
            port: 4318
          - path: /loki
            pathType: Prefix
            port: 3101
